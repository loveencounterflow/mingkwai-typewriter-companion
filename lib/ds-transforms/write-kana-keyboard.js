// Generated by CoffeeScript 2.4.1
(function() {
  'use strict';
  var $, $async, CND, FS, JACONV, L, PATH, PD, TRIODE, assign, badge, debug, echo, help, info, jr, length_of, rpr, select, terminate, urge, warn, whisper;

  //###########################################################################################################
  CND = require('cnd');

  rpr = CND.rpr;

  badge = '明快打字机/DS-TRANSFORMS/WRITE-KANA-KEYBOARD';

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  info = CND.get_logger('info', badge);

  urge = CND.get_logger('urge', badge);

  help = CND.get_logger('help', badge);

  whisper = CND.get_logger('whisper', badge);

  echo = CND.echo.bind(CND);

  //...........................................................................................................
  FS = require('fs');

  PATH = require('path');

  PD = require('pipedreams');

  ({$, $async, select} = PD);

  ({assign, jr} = CND);

  TRIODE = require('triode');

  JACONV = require('jaconv');

  require('../exception-handler');

  length_of = function(x) {
    return (Object.keys(x)).length;
  };

  terminate = function() {
    warn('terminating');
    return process.exit(1);
  };

  //-----------------------------------------------------------------------------------------------------------
  this._drop_extension = function(path) {
    return path.slice(0, path.length - (PATH.extname(path)).length);
  };

  this._xray = function(text) {
    var chr, i, len, ref, results;
    ref = Array.from(text);
    results = [];
    for (i = 0, len = ref.length; i < len; i++) {
      chr = ref[i];
      results.push((chr.codePointAt(0)).toString(16));
    }
    return results;
  };

  this.$as_line = function() {
    return $((d, send) => {
      return send((jr(d)) + '\n');
    });
  };

  this._resolve_dec_entities = function(text) {
    return text.replace(/&#([0-9a-f]+);/ig, function($0, $1) {
      return String.fromCodePoint(parseInt($1, 10));
    });
  };

  this._resolve_hex_entities = function(text) {
    return text.replace(/&#x([0-9a-f]+);/ig, function($0, $1) {
      return String.fromCodePoint(parseInt($1, 16));
    });
  };

  this._resolve_entities = function(text) {
    return this._resolve_dec_entities(this._resolve_hex_entities(text));
  };

  // debug @_xray '𪜈゙  ドモ'; xxx

  // debug rpr @_resolve_entities 'xxx&#x20;xxx'
  // process.exit 1

  //-----------------------------------------------------------------------------------------------------------
  this.$name_fields = function() {
    return $((d, send) => {
      var source, target;
      [source, target] = d;
      return send({source, target});
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$add_sections = function() {
    var section;
    section = null;
    return $((d, send) => {
      if (d.source === 'SECTION') {
        section = (d.target.split(/\s+/))[0].toLowerCase();
      } else {
        if (section != null) {
          d.section = section;
        }
        send(d);
      }
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$feed_triode = function() {
    var duplicates, last, triode;
    last = Symbol('last');
    triode = TRIODE.new();
    duplicates = {};
    //.........................................................................................................
    return $({last}, (d, send) => {
      var count, source, targets;
      if (d === last) {
        if ((count = length_of(duplicates)) > 0) {
          for (source in duplicates) {
            targets = duplicates[source];
            warn(`duplicate: ${source} -> ${targets.join(', ')}`);
          }
          warn(`µ44874 detected ${count} duplicates (see listing above)`);
          terminate();
        }
        // throw new Error "µ44874 detected #{count} duplicates (see listing above)"
        return send(triode);
      }
      //.......................................................................................................
      if (triode.has(d.source)) {
        if ((targets = duplicates[d.source]) == null) {
          targets = duplicates[d.source] = [triode.get(d.source)];
        }
        return targets.push(d.target);
      }
      //.......................................................................................................
      triode.set(d.source, d.target);
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$resolve_entities = () => {
    return PD.$watch((d) => {
      d.source = this._resolve_entities(d.source);
      return d.target = this._resolve_entities(d.target);
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$remove_inline_comments = () => {
    return PD.$watch((d) => {
      return d.target = d.target.replace(/\s+#\s+.*$/g, '');
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$process_hentaigana = () => {
    var nr, seen;
    nr = 0;
    seen = {};
    return $((d, send) => {
      var e, f;
      if (d.section !== 'hentaigana') {
        return send(d);
      }
      nr += +1;
      e = assign({}, d);
      e.source = `\\h-${e.source}-${nr}.`;
      e.target = e.target.replace(/\(.*$/g, '');
      send(e);
      f = assign({}, d);
      f.source = `\\m-${f.source}-${nr}.`;
      f.target = f.target.replace(/^.+\((.+)\)$/g, '$1');
      if (!seen[f.target]) {
        send(f);
      }
      return seen[f.target] = true;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$add_katakana = () => {
    var seen;
    seen = {};
    return $((d, send) => {
      var e, f, source, target;
      seen[d.source] = d.target;
      send(d);
      //.......................................................................................................
      source = d.source.toUpperCase();
      target = JACONV.toKatakana(d.target);
      if (source !== d.source) {
        if (source in seen) {
          urge(`dropping ${source} -> ${target} in favor of ${seen[source]}`);
        } else {
          if (target !== d.target) {
            seen[source] = target;
            e = assign({}, d);
            e.source = source;
            e.target = target;
            send(e);
          }
        }
      }
      //.......................................................................................................
      source = '^' + d.source;
      target = JACONV.toHanKana(JACONV.toKatakana(d.target));
      if (source !== d.source) {
        if (source in seen) {
          urge(`dropping ${source} -> ${target} in favor of ${seen[source]}`);
        } else {
          if (target !== d.target) {
            seen[source] = target;
            f = assign({}, d);
            f.source = source;
            f.target = target;
            send(f);
          }
        }
      }
      //.......................................................................................................
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$postprocess = function() {
    return PD.$watch((triode) => {
      triode.disambiguate_subkey('n', 'n.');
      triode.disambiguate_subkey('v', 'v.');
      // triode.disambiguate_subkey 'vv', 'vv.'
      triode.disambiguate_subkey('N', 'N.');
      triode.disambiguate_subkey('V', 'V.');
      triode.disambiguate_subkey('^n', '^n.');
      triode.disambiguate_subkey('^v', '^v.');
      // for subkey, superkeys of triode.get_all_superkeys()
      //   help "µ46474 resolving #{rpr subkey} -> #{rpr superkeys}"
      //   triode.apply_replacements_recursively subkey
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$write_kbd = (target_path) => {
    var pipeline;
    pipeline = [];
    pipeline.push(PD.$watch((triode) => {
      var count, source, superkeys, targets;
      if ((count = length_of((superkeys = triode.get_all_superkeys()))) > 0) {
        for (source in superkeys) {
          targets = superkeys[source];
          warn(`unresolved superkey: ${source} -> ${targets.join(', ')}`);
        }
        warn(`µ44875 detected ${count} unresolved superkeys (see listing above)`);
        return terminate();
      }
    }));
    pipeline.push($((triode, send) => {
      return send(triode.replacements_as_js_module_text());
    }));
    pipeline.push(PD.write_to_file(target_path));
    return PD.$tee(PD.pull(...pipeline));
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$write_cdt = (target_path) => {
    var pipeline;
    pipeline = [];
    pipeline.push($((triode, send) => {
      return send(triode.as_js_module_text());
    }));
    pipeline.push(PD.write_to_file(target_path));
    return PD.$tee(PD.pull(...pipeline));
  };

  //-----------------------------------------------------------------------------------------------------------
  this.write_cache = function(settings) {
    return new Promise((resolve, reject) => {
      var cdt_target_filename, cdt_target_path, convert, kbd_target_filename, kbd_target_path;
      kbd_target_filename = (this._drop_extension(PATH.basename(settings.source_path))) + '.kbd.js';
      cdt_target_filename = (this._drop_extension(PATH.basename(settings.source_path))) + '.cdt.js';
      kbd_target_path = PATH.resolve(PATH.join(__dirname, '../../.cache', kbd_target_filename));
      cdt_target_path = PATH.resolve(PATH.join(__dirname, '../../.cache', cdt_target_filename));
      help(`translating ${rpr(PATH.relative(process.cwd(), settings.source_path))}`);
      //.........................................................................................................
      convert = () => {
        var pipeline;
        pipeline = [];
        pipeline.push(PD.read_from_file(settings.source_path));
        // pipeline.push PD.$split()
        pipeline.push(PD.$split_wsv(2));
        pipeline.push(this.$name_fields());
        pipeline.push(this.$add_sections());
        pipeline.push(this.$remove_inline_comments());
        pipeline.push(this.$resolve_entities());
        pipeline.push(this.$process_hentaigana());
        pipeline.push(this.$add_katakana());
        // pipeline.push PD.$show()
        pipeline.push(this.$feed_triode());
        pipeline.push(this.$postprocess());
        if (settings.postprocess != null) {
          pipeline.push(PD.$watch(function(triode) {
            return settings.postprocess(triode);
          }));
        }
        pipeline.push(this.$write_kbd(kbd_target_path));
        pipeline.push(this.$write_cdt(cdt_target_path));
        pipeline.push(PD.$drain(() => {
          help(`wrote output to ${rpr(PATH.relative(process.cwd(), kbd_target_path))}`);
          return resolve();
        }));
        PD.pull(...pipeline);
        return null;
      };
      //.........................................................................................................
      convert();
      return null;
    });
  };

  //###########################################################################################################
  if (module.parent == null) {
    L = this;
    (async function() {
      var settings;
      //.......................................................................................................
      settings = {
        source_path: PATH.resolve(PATH.join(__dirname, '../../db/jp_kana.wsv'))
      };
      return (await L.write_cache(settings));
    })();
  }

  // #.......................................................................................................
// settings =
//   source_path:  PATH.resolve PATH.join __dirname, '../../db/gr_gr.keyboard.wsv'
//   postprocess: ( triode ) ->
//     debug 'µ77622', triode.get_all_superkeys()
//   #   triode.disambiguate_subkey 'n', 'n.'
//   #   triode.disambiguate_subkey 'v', 'v.'
//   #   for subkey, superkeys of triode.get_all_superkeys()
//   #     help "µ46474 resolving #{rpr subkey} -> #{rpr superkeys}"
//   #     triode.apply_replacements_recursively subkey
//   #   return null
// await L.write_cache settings
// help 'ok'

}).call(this);

//# sourceMappingURL=write-kana-keyboard.js.map
